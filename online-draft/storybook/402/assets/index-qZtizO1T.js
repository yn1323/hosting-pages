import{r as j,G as g,j as t,B as O}from"./iframe-CPNykFu4.js";import{I as w}from"./index-BGCE8b3C.js";import{R as U}from"./responsive-modal-DETIp2Db.js";import{u as W}from"./useChat-3hcy5X5y.js";import{d as P}from"./common-CxXojnM3.js";import{d as X,s as Y,b as J}from"./index.esm-ClM2GOLW.js";import{u as K,a as Q,o as Z,s as R}from"./zod-CJOOa1KA.js";import{u as ee}from"./useModal-JLMgYJoB.js";import{g as te,u as oe,c as re,s as ne,b as ie}from"./states-BgKcEv6C.js";import{n as z}from"./index-DFT-raW7.js";import{V as M}from"./v-stack-ZFthQQXO.js";import{H as D}from"./h-stack-IZP0I_-8.js";import{T as u}from"./index-DeSftEHM.js";const ae=()=>({upsertSelection:j.useCallback(async a=>{const{groupId:c,userId:o,item:e,comment:s,round:n,currentSelections:l}=a;try{const r=Math.floor(Math.random()*1e6),y=X(P,"app/onlinedraft/selection",o),h=l.filter(m=>m.userId===o).filter(m=>m.round!==n),S={item:e,comment:s,round:n,randomNumber:r},I=[...h.map(m=>({item:m.item,comment:m.comment,round:m.round,randomNumber:m.randomNumber})),S],b={userId:o,selection:I,updatedAt:Y()};return await J(y,b),c}catch(r){throw console.error("選択データのupsertに失敗しました:",r),r}},[])}),v=50,E=20,A=100,se=(i,a,c,o,e)=>{if(!i||a===null||a===void 0)return{modalTitle:e.title,defaultItem:"",defaultComment:"",isEditMode:!1,editContext:void 0};const s=o.find(r=>r.id===i),n=c.find(r=>r.userId===i&&r.round===a),l=!!n;return{modalTitle:l?e.editTitle:e.title,defaultItem:(n==null?void 0:n.item)||"",defaultComment:(n==null?void 0:n.comment)||"",isEditMode:l,editContext:l&&s?{round:a,playerName:s.name}:void 0}},le=(i,a,c,o,e)=>Z({item:R().min(1,o.itemRequired).max(v,o.itemMaxLength).refine(s=>i&&e&&s.toLowerCase()===e.toLowerCase()?!0:!a.filter(r=>r.round<c).some(r=>r.item.toLowerCase()===s.toLowerCase()),o.alreadySelected),comment:R().max(i?E:A,i?o.categoryMaxLength:o.commentMaxLength).default("")}),V=ee,q=({isOpen:i,onClose:a,userId:c,round:o})=>{const e=z("draft"),s=z("common"),n=j.useId(),l=g(ne),r=g(oe),y=g(re),C=g(ie),{round:h}=g(te),S=r.find(({id:f})=>f===y),{sendSystemMessage:I}=W(),b=j.useMemo(()=>({itemRequired:e("itemSelectModal.validation.itemRequired"),itemMaxLength:e("itemSelectModal.validation.itemMaxLength",{max:v}),categoryMaxLength:e("itemSelectModal.validation.categoryMaxLength",{max:E}),commentMaxLength:e("itemSelectModal.validation.commentMaxLength",{max:A}),alreadySelected:e("itemSelectModal.validation.alreadySelected")}),[e]),{modalTitle:m,defaultItem:x,defaultComment:B,isEditMode:k,editContext:d}=se(c,o,l,r,{title:e("itemSelectModal.title"),editTitle:e("itemSelectModal.editTitle")}),{upsertSelection:G}=ae(),{register:F,handleSubmit:H,formState:{errors:p,isSubmitting:L},reset:T}=K({resolver:Q(le(k,l,h,b,x)),mode:"onChange",defaultValues:{item:x,comment:B}}),$=async f=>{try{if(await G({groupId:C,userId:c,item:f.item,comment:f.comment,round:o,currentSelections:l}),h!==o&&x!==f.item){const _=S==null?void 0:S.name;await I(C,`[${o}R-${d==null?void 0:d.playerName}] ${x}→${f.item} by ${_}`)}a(),T()}catch(_){console.error(e("itemSelectModal.toast.error"),_)}},N=()=>{L||(a(),T())};return t.jsx(U,{isOpen:i,onClose:N,title:m,actions:{cancel:{text:s("actions.cancel"),onClick:N},submit:{text:s("actions.confirm"),type:"submit",form:n,loading:L,disabled:L}},children:t.jsxs(M,{as:"form",id:n,onSubmit:H($),gap:4,w:"full",children:[d&&t.jsx(O,{w:"full",p:3,bg:"gray.50",borderRadius:"md",children:t.jsxs(M,{gap:2,align:"start",children:[t.jsxs(D,{children:[t.jsx(u,{fontSize:"xs",color:"gray.600",children:e("itemSelectModal.roundLabel")}),t.jsxs(u,{fontSize:"sm",fontWeight:"bold",children:["Round ",d.round]})]}),t.jsxs(D,{children:[t.jsx(u,{fontSize:"xs",color:"gray.600",children:e("itemSelectModal.playerLabel")}),t.jsx(u,{fontSize:"sm",fontWeight:"bold",children:d.playerName})]})]})}),t.jsxs(M,{gap:2,align:"start",w:"full",children:[t.jsx(u,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:e("itemSelectModal.itemLabel")}),t.jsx(w,{...F("item"),placeholder:e("itemSelectModal.itemPlaceholder"),maxLength:v,size:"lg",error:!!p.item}),p.item&&t.jsx(u,{fontSize:"sm",color:"red.500",children:p.item.message})]}),t.jsxs(M,{gap:2,align:"start",w:"full",children:[t.jsx(u,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:e("itemSelectModal.commentLabel")}),t.jsx(w,{...F("comment"),placeholder:e(d?"itemSelectModal.categoryPlaceholder":"itemSelectModal.commentPlaceholder"),maxLength:d?E:A,size:"lg",error:!!p.comment}),p.comment&&t.jsx(u,{fontSize:"sm",color:"red.500",children:p.comment.message})]})]})})};try{V.displayName="useItemSelectModal",V.__docgenInfo={description:`アイテム選択モーダル用hooks
汎用useModalを利用した軽量実装`,displayName:"useItemSelectModal",props:{}}}catch{}try{q.displayName="ItemSelectModal",q.__docgenInfo={description:`アイテム選択モーダルコンポーネント
react-hook-form + zodバリデーション使用`,displayName:"ItemSelectModal",props:{isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},round:{defaultValue:null,description:"",name:"round",required:!0,type:{name:"number"}}}}}catch{}export{q as I,V as u};
