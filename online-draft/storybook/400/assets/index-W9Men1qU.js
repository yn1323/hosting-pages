import{r as R,G as S,j as e,B as k}from"./iframe-C_rgkzEe.js";import{I as w}from"./index-B8p9ccOV.js";import{R as G}from"./responsive-modal-DxvuhESA.js";import{u as H}from"./useChat-C7amTuMm.js";import{d as q}from"./common-CxXojnM3.js";import{d as O,s as U,b as W}from"./index.esm-ClM2GOLW.js";import{u as X,a as Y,o as J,s as T}from"./zod-B8d8-S5d.js";import{u as K}from"./useModal-DGbiGf-9.js";import{g as P,u as Q,c as Z,s as ee,b as te}from"./states-C-6AC4D5.js";import{V as C}from"./v-stack-BdZrG5lB.js";import{H as z}from"./h-stack-kLvObkFg.js";import{T as c}from"./index-DvCjFio_.js";const oe=()=>({upsertSelection:R.useCallback(async n=>{const{groupId:l,userId:o,item:i,comment:t,round:a,currentSelections:s}=n;try{const d=Math.floor(Math.random()*1e6),h=O(q,"app/onlinedraft/selection",o),y=s.filter(u=>u.userId===o).filter(u=>u.round!==a),I={item:i,comment:t,round:a,randomNumber:d},p=[...y.map(u=>({item:u.item,comment:u.comment,round:u.round,randomNumber:u.randomNumber})),I],b={userId:o,selection:p,updatedAt:U()};return await W(h,b),l}catch(d){throw console.error("選択データのupsertに失敗しました:",d),d}},[])}),E=50,M=20,A=100,re=(r,n,l,o)=>{if(!r||n===null||n===void 0)return{modalTitle:"ドラフト指名",defaultItem:"",defaultComment:"",isEditMode:!1,editContext:void 0};const i=o.find(s=>s.id===r),t=l.find(s=>s.userId===r&&s.round===n),a=!!t;return{modalTitle:a?"ドラフト指名を編集":"ドラフト指名",defaultItem:(t==null?void 0:t.item)||"",defaultComment:(t==null?void 0:t.comment)||"",isEditMode:a,editContext:a&&i?{round:n,playerName:i.name}:void 0}},se=(r,n,l,o)=>J({item:T().min(1,"アイテム名を入力してください").max(E,`${E}文字以内で入力してください`).refine(i=>r&&o&&i.toLowerCase()===o.toLowerCase()?!0:!n.filter(s=>s.round<l).some(s=>s.item.toLowerCase()===i.toLowerCase()),"このアイテムは過去のラウンドで既に選択されています"),comment:T().max(r?M:A,r?`${M}文字以内で入力してください`:`${A}文字以内で入力してください`).default("")}),D=K,L=({isOpen:r,onClose:n,userId:l,round:o})=>{const i=R.useId(),t=S(ee),a=S(Q),s=S(Z),d=S(te),{round:h}=S(P),x=a.find(({id:g})=>g===s),{sendSystemMessage:y}=H(),{modalTitle:I,defaultItem:p,defaultComment:b,isEditMode:u,editContext:m}=re(l,o,t,a),{upsertSelection:V}=oe(),{register:F,handleSubmit:$,formState:{errors:f,isSubmitting:_},reset:v}=X({resolver:Y(se(u,t,h,p)),mode:"onChange",defaultValues:{item:p,comment:b}}),B=async g=>{try{if(await V({groupId:d,userId:l,item:g.item,comment:g.comment,round:o,currentSelections:t}),h!==o&&p!==g.item){const j=x==null?void 0:x.name;await y(d,`[${o}R-${m==null?void 0:m.playerName}] ${p}→${g.item} by ${j}`)}n(),v()}catch(j){console.error("指名エラー:",j)}},N=()=>{_||(n(),v())};return e.jsx(G,{isOpen:r,onClose:N,title:I,actions:{cancel:{text:"キャンセル",onClick:N},submit:{text:"決定",type:"submit",form:i,loading:_,disabled:_}},children:e.jsxs(C,{as:"form",id:i,onSubmit:$(B),gap:4,w:"full",children:[m&&e.jsx(k,{w:"full",p:3,bg:"gray.50",borderRadius:"md",children:e.jsxs(C,{gap:2,align:"start",children:[e.jsxs(z,{children:[e.jsx(c,{fontSize:"xs",color:"gray.600",children:"ラウンド:"}),e.jsxs(c,{fontSize:"sm",fontWeight:"bold",children:["Round ",m.round]})]}),e.jsxs(z,{children:[e.jsx(c,{fontSize:"xs",color:"gray.600",children:"プレイヤー:"}),e.jsx(c,{fontSize:"sm",fontWeight:"bold",children:m.playerName})]})]})}),e.jsxs(C,{gap:2,align:"start",w:"full",children:[e.jsx(c,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"ドラフト指名"}),e.jsx(w,{...F("item"),placeholder:"指名を入力してください",maxLength:E,size:"lg",error:!!f.item}),f.item&&e.jsx(c,{fontSize:"sm",color:"red.500",children:f.item.message})]}),e.jsxs(C,{gap:2,align:"start",w:"full",children:[e.jsx(c,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"コメント（任意）"}),e.jsx(w,{...F("comment"),placeholder:m?"コメントを入力してください":"この指名についてのコメント...",maxLength:m?M:A,size:"lg",error:!!f.comment}),f.comment&&e.jsx(c,{fontSize:"sm",color:"red.500",children:f.comment.message})]})]})})};try{D.displayName="useItemSelectModal",D.__docgenInfo={description:`アイテム選択モーダル用hooks
汎用useModalを利用した軽量実装`,displayName:"useItemSelectModal",props:{}}}catch{}try{L.displayName="ItemSelectModal",L.__docgenInfo={description:`アイテム選択モーダルコンポーネント
react-hook-form + zodバリデーション使用`,displayName:"ItemSelectModal",props:{isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},round:{defaultValue:null,description:"",name:"round",required:!0,type:{name:"number"}}}}}catch{}export{L as I,D as u};
